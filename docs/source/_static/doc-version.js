"use strict";

function getGhPagesCurrentFolder() {
  // Extract version folder under the assumpgion that the URL is of the form
  // https://<username>.github.io/<project>/<version>/...
  if (window.location.hostname.includes("github.io")){
    return window.location.pathname.split('/')[2];
  }
}

function getRootUrl() {
  // Return the "root" URL, i.e. everything before the current folder
  // (getGhPagesCurrentFolder). On gh-pages, this includes the project name.
  var root_url = window.location.origin;
  if (window.location.hostname.includes("github.io")){
    root_url = root_url + '/' + window.location.pathname.split('/')[1];
  }
  return root_url;
}

function getGithubProjectUrl(){
  // Return the project url on Github, under the assumption that the current
  // page is hosted on github-pages (https://<username>.github.io/<project>/)
  var root_url = getRootUrl();
  var match = root_url.match(/([\w\d-]+)\.github\.io\/([\w\d-]+)/)
  if (match !== null){
    var username = match[1];
    var projectname = match[2];
    return "https://github.com/" + username + "/" + projectname;
  } else {
    return null
  }
}

function _addVersionsMenu(version_data) {
  // The menu was reverse-engineered from the RTD websites, so it's very
  // specific to the sphinx_rtd_theme
  var folders = version_data["versions"];
  var root_url = getRootUrl();
  var current_url = document.URL;
  var current_folder = getGhPagesCurrentFolder() || "latest";
  //if (current_folder === undefined) return;
  var current_version = version_data["labels"][current_folder];
  var menu = document.createElement('div');
  menu.setAttribute('class', 'rst-versions');
  menu.setAttribute('data-toggle', 'rst-versions');
  menu.setAttribute('role', 'note');
  menu.setAttribute('aria-label', 'versions');
  var inner_html =
    "<span class='rst-current-version' data-toggle='rst-current-version'>" +
      "<span class='fa fa-book'> Doctr </span>" +
      "<span>" + current_version + " </span>" +
      "<span class='fa fa-caret-down'></span>" +
    "</span>" +
    "<div class='rst-other-versions'>" +
      "<div class='injected'>" +
        "<dl>" +
          "<dt>Versions</dt>";
  var i;
  console.log('Folders: ', folders);
  for (i in folders) {
    var folder = folders[i];
    if (folder == current_folder){
      var inner_html = inner_html + "<strong><dd><a href='"
                       + current_url
                       + "'>" + current_version + "</a></dd></strong>";
    } else {
      console.log('Current folder: ', current_folder, 'Folder: ', folder);
      console.log('Current url: ', current_url, current_url.replace(current_folder, folder));
      var inner_html = inner_html + "<dd><a href='"
                       + current_url.replace(current_folder, folder)
                       + "'>" + version_data["labels"][folder] + "</a></dd>";
    }
  }

  console.log('Inner HTML: ', inner_html);
  
  var inner_html = inner_html +
        "</dl>" +
        "<hr>" +
        "<small>Generated by <a href='https://goerz.github.io/doctr_versions_menu'>Doctr Versions Menu</a>" +
        "</small>" +
      "</div>" +
    "</div>";
  menu.innerHTML = inner_html;
  var parent = document.body;
  parent.insertBefore(menu, parent.lastChild);

  console.log("Doctr Versions Menu: Injected versions menu");

}

function addVersionsMenu() {
  // We assume that we can load versions.json from
  // https://<username>.github.io/<project>/versions.json
  // That is, there's a <project> path between the hostname and versions.json
  var json_file = "/" + window.location.pathname.split("/")[1] + "/versions.json";
  //var json_file = '/Users/enmanuelmagallanes/Desktop/Code/CERN/quasar/docs/_build/latest/versions.json';

  _addVersionsMenu(
    {"folders": ["latest", "test"], "default-branch": null, "labels": {"latest": "latest", "test": "test"}, "versions": ["test", "latest"], "warnings": {"latest": ["unreleased"], "test": ["unreleased"]}, "latest": null, "downloads": {"latest": [], "test": []}}
  )
}

document.addEventListener('DOMContentLoaded', addVersionsMenu);